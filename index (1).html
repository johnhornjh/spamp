<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 100%;
        }
        
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
            }
        }
        
        .tools {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 250px;
        }
        
        .tool-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .tool-section h3 {
            margin-bottom: 5px;
            color: #444;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .color-picker {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            border: 2px solid #333;
        }
        
        .brush-size {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .size-value {
            text-align: center;
            font-weight: bold;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: #4a6fa5;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #3a5a80;
        }
        
        button.active {
            background-color: #2c4a6b;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }
        
        button.eraser {
            background-color: #f0ad4e;
        }
        
        button.eraser:hover, button.eraser.active {
            background-color: #ec971f;
        }
        
        button.clear {
            background-color: #d9534f;
        }
        
        button.clear:hover {
            background-color: #c9302c;
        }
        
        button.save {
            background-color: #5cb85c;
        }
        
        button.save:hover {
            background-color: #449d44;
        }
        
        .canvas-container {
            position: relative;
            background-color: #ddd;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        canvas {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: crosshair;
            touch-action: none;
            display: block;
        }
        
        .custom-color {
            margin-top: 10px;
        }
        
        input[type="color"] {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-upload {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .file-upload-btn {
            background-color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .file-upload-btn:hover {
            background-color: #5a6268;
        }
        
        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .slider-value {
            text-align: center;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .history-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .history-buttons button {
            flex: 1;
        }
        
        .crop-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .crop-controls button {
            flex: 1;
        }
        
        .text-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .text-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .filter-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .filter-buttons button {
            padding: 8px;
            font-size: 0.9em;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 10px;
            display: none;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>Image Editor</h1>
    <div class="container">
        <div class="tools">
            <div class="tabs">
                <div class="tab active" data-tab="draw">Draw</div>
                <div class="tab" data-tab="image">Image</div>
                <div class="tab" data-tab="filters">Filters</div>
                <div class="tab" data-tab="text">Text</div>
            </div>
            
            <!-- Draw Tab -->
            <div class="tab-content active" id="draw-tab">
                <div class="tool-section">
                    <h3>Colors</h3>
                    <div class="color-picker">
                        <div class="color-option selected" style="background-color: #000000;" data-color="#000000"></div>
                        <div class="color-option" style="background-color: #ffffff;" data-color="#ffffff"></div>
                        <div class="color-option" style="background-color: #ff0000;" data-color="#ff0000"></div>
                        <div class="color-option" style="background-color: #00ff00;" data-color="#00ff00"></div>
                        <div class="color-option" style="background-color: #0000ff;" data-color="#0000ff"></div>
                        <div class="color-option" style="background-color: #ffff00;" data-color="#ffff00"></div>
                        <div class="color-option" style="background-color: #ff00ff;" data-color="#ff00ff"></div>
                        <div class="color-option" style="background-color: #00ffff;" data-color="#00ffff"></div>
                        <div class="color-option" style="background-color: #ffa500;" data-color="#ffa500"></div>
                    </div>
                    <div class="custom-color">
                        <h3>Custom Color</h3>
                        <input type="color" id="colorPicker" value="#000000">
                    </div>
                </div>
                
                <div class="tool-section">
                    <h3>Brush Size</h3>
                    <div class="brush-size">
                        <input type="range" id="brushSize" min="1" max="50" value="5">
                        <div class="size-value" id="sizeValue">5px</div>
                    </div>
                </div>
                
                <div class="tool-section">
                    <h3>Tools</h3>
                    <div class="action-buttons">
                        <button id="drawBtn" class="active">Draw</button>
                        <button id="eraserBtn" class="eraser">Eraser</button>
                    </div>
                </div>
            </div>
            
            <!-- Image Tab -->
            <div class="tab-content" id="image-tab">
                <div class="tool-section">
                    <h3>Image</h3>
                    <div class="file-upload">
                        <label for="imageUpload" class="file-upload-btn">
                            <span>Upload Image</span>
                        </label>
                        <input type="file" id="imageUpload" accept="image/*">
                    </div>
                </div>
                
                <div class="tool-section">
                    <h3>Adjustments</h3>
                    <div class="slider-container">
                        <label for="brightness">Brightness</label>
                        <input type="range" id="brightness" min="-100" max="100" value="0">
                        <div class="slider-value" id="brightnessValue">0</div>
                    </div>
                    <div class="slider-container">
                        <label for="contrast">Contrast</label>
                        <input type="range" id="contrast" min="-100" max="100" value="0">
                        <div class="slider-value" id="contrastValue">0</div>
                    </div>
                    <div class="slider-container">
                        <label for="saturation">Saturation</label>
                        <input type="range" id="saturation" min="-100" max="100" value="0">
                        <div class="slider-value" id="saturationValue">0</div>
                    </div>
                </div>
                
                <div class="tool-section">
                    <h3>Transform</h3>
                    <div class="action-buttons">
                        <button id="rotateLeftBtn">Rotate Left</button>
                        <button id="rotateRightBtn">Rotate Right</button>
                        <button id="flipHBtn">Flip Horizontal</button>
                        <button id="flipVBtn">Flip Vertical</button>
                    </div>
                </div>
                
                <div class="tool-section">
                    <h3>Crop</h3>
                    <div class="action-buttons">
                        <button id="cropBtn">Start Crop</button>
                        <div class="crop-controls" id="cropControls" style="display: none;">
                            <button id="applyCropBtn">Apply</button>
                            <button id="cancelCropBtn">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters Tab -->
            <div class="tab-content" id="filters-tab">
                <div class="tool-section">
                    <h3>Filters</h3>
                    <div class="filter-buttons">
                        <button id="grayscaleBtn">Grayscale</button>
                        <button id="sepiaBtn">Sepia</button>
                        <button id="invertBtn">Invert</button>
                        <button id="blurBtn">Blur</button>
                        <button id="sharpenBtn">Sharpen</button>
                        <button id="edgeDetectBtn">Edge Detect</button>
                        <button id="embossBtn">Emboss</button>
                        <button id="vintageBtn">Vintage</button>
                    </div>
                </div>
                
                <div class="tool-section">
                    <h3>Reset</h3>
                    <div class="action-buttons">
                        <button id="resetFiltersBtn">Reset Filters</button>
                    </div>
                </div>
            </div>
            
            <!-- Text Tab -->
            <div class="tab-content" id="text-tab">
                <div class="tool-section">
                    <h3>Add Text</h3>
                    <div class="text-controls">
                        <input type="text" id="textInput" class="text-input" placeholder="Enter text...">
                        <div class="slider-container">
                            <label for="fontSize">Font Size</label>
                            <input type="range" id="fontSize" min="10" max="100" value="30">
                            <div class="slider-value" id="fontSizeValue">30px</div>
                        </div>
                        <input type="color" id="textColor" value="#000000">
                        <select id="fontFamily" class="text-input">
                            <option value="Arial">Arial</option>
                            <option value="Verdana">Verdana</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Courier New">Courier New</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Comic Sans MS">Comic Sans MS</option>
                        </select>
                        <button id="addTextBtn">Add Text</button>
                        <button id="cancelTextBtn" style="display: none;">Cancel Text</button>
                    </div>
                </div>
            </div>
            
            <div class="tool-section">
                <h3>History</h3>
                <div class="history-buttons">
                    <button id="undoBtn">Undo</button>
                    <button id="redoBtn">Redo</button>
                </div>
            </div>
            
            <div class="tool-section">
                <h3>Actions</h3>
                <div class="action-buttons">
                    <button id="clearBtn" class="clear">Clear Canvas</button>
                    <button id="saveBtn" class="save">Save Image</button>
                </div>
            </div>
        </div>
        
        <div class="canvas-container">
            <canvas id="drawingCanvas" width="800" height="600"></canvas>
            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Canvas setup
            const canvas = document.getElementById('drawingCanvas');
            const ctx = canvas.getContext('2d');
            
            // UI elements
            const colorOptions = document.querySelectorAll('.color-option');
            const colorPicker = document.getElementById('colorPicker');
            const brushSizeSlider = document.getElementById('brushSize');
            const sizeValue = document.getElementById('sizeValue');
            const drawBtn = document.getElementById('drawBtn');
            const eraserBtn = document.getElementById('eraserBtn');
            const clearBtn = document.getElementById('clearBtn');
            const saveBtn = document.getElementById('saveBtn');
            const imageUpload = document.getElementById('imageUpload');
            const brightnessSlider = document.getElementById('brightness');
            const contrastSlider = document.getElementById('contrast');
            const saturationSlider = document.getElementById('saturation');
            const brightnessValue = document.getElementById('brightnessValue');
            const contrastValue = document.getElementById('contrastValue');
            const saturationValue = document.getElementById('saturationValue');
            const rotateLeftBtn = document.getElementById('rotateLeftBtn');
            const rotateRightBtn = document.getElementById('rotateRightBtn');
            const flipHBtn = document.getElementById('flipHBtn');
            const flipVBtn = document.getElementById('flipVBtn');
            const cropBtn = document.getElementById('cropBtn');
            const applyCropBtn = document.getElementById('applyCropBtn');
            const cancelCropBtn = document.getElementById('cancelCropBtn');
            const cropControls = document.getElementById('cropControls');
            const grayscaleBtn = document.getElementById('grayscaleBtn');
            const sepiaBtn = document.getElementById('sepiaBtn');
            const invertBtn = document.getElementById('invertBtn');
            const blurBtn = document.getElementById('blurBtn');
            const sharpenBtn = document.getElementById('sharpenBtn');
            const edgeDetectBtn = document.getElementById('edgeDetectBtn');
            const embossBtn = document.getElementById('embossBtn');
            const vintageBtn = document.getElementById('vintageBtn');
            const resetFiltersBtn = document.getElementById('resetFiltersBtn');
            const textInput = document.getElementById('textInput');
            const fontSizeSlider = document.getElementById('fontSize');
            const fontSizeValue = document.getElementById('fontSizeValue');
            const textColor = document.getElementById('textColor');
            const fontFamily = document.getElementById('fontFamily');
            const addTextBtn = document.getElementById('addTextBtn');
            const cancelTextBtn = document.getElementById('cancelTextBtn');
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            // Initialize canvas with white background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Drawing state
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            let currentColor = '#000000';
            let brushSize = 5;
            let isEraser = false;
            
            // Image state
            let originalImage = null;
            let hasImage = false;
            
            // History state
            let history = [];
            let redoStack = [];
            let currentState = null;
            
            // Text state
            let isAddingText = false;
            let textX = 0;
            let textY = 0;
            let fontSize = 30;
            
            // Crop state
            let isCropping = false;
            let cropStartX = 0;
            let cropStartY = 0;
            let cropEndX = 0;
            let cropEndY = 0;
            
            // Save initial state
            saveState();
            
            // Adjust canvas size based on window size
            function resizeCanvas() {
                const container = document.querySelector('.canvas-container');
                const maxWidth = Math.min(800, container.offsetWidth - 20); // 20px for padding
                const ratio = canvas.height / canvas.width;
                
                canvas.style.width = maxWidth + 'px';
                canvas.style.height = (maxWidth * ratio) + 'px';
            }
            
            // Call resize on load and window resize
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Update brush size display
            function updateSizeValue() {
                sizeValue.textContent = brushSize + 'px';
            }
            
            // Update font size display
            function updateFontSizeValue() {
                fontSizeValue.textContent = fontSize + 'px';
            }
            
            // Draw line function
            function drawLine(x1, y1, x2, y2) {
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.strokeStyle = isEraser ? 'white' : currentColor;
                ctx.lineWidth = brushSize;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
            }
            
            // Get canvas coordinates from event
            function getCanvasCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                if (e.type.includes('touch')) {
                    return {
                        x: (e.touches[0].clientX - rect.left) * scaleX,
                        y: (e.touches[0].clientY - rect.top) * scaleY
                    };
                } else {
                    return {
                        x: (e.clientX - rect.left) * scaleX,
                        y: (e.clientY - rect.top) * scaleY
                    };
                }
            }
            
            // Start drawing
            function startDrawing(e) {
                if (isCropping || isAddingText) return;
                
                isDrawing = true;
                const coords = getCanvasCoordinates(e);
                lastX = coords.x;
                lastY = coords.y;
                
                // Draw a dot at the starting point
                ctx.beginPath();
                ctx.arc(lastX, lastY, brushSize / 2, 0, Math.PI * 2);
                ctx.fillStyle = isEraser ? 'white' : currentColor;
                ctx.fill();
            }
            
            // Draw
            function draw(e) {
                if (!isDrawing || isCropping || isAddingText) return;
                e.preventDefault();
                
                const coords = getCanvasCoordinates(e);
                drawLine(lastX, lastY, coords.x, coords.y);
                lastX = coords.x;
                lastY = coords.y;
            }
            
            // Stop drawing
            function stopDrawing() {
                if (isDrawing) {
                    isDrawing = false;
                    saveState();
                }
            }
            
            // Save current state to history
            function saveState() {
                // Limit history size to prevent memory issues
                if (history.length >= 20) {
                    history.shift();
                }
                
                currentState = ctx.getImageData(0, 0, canvas.width, canvas.height);
                history.push(currentState);
                redoStack = []; // Clear redo stack when a new action is performed
            }
            
            // Undo last action
            function undo() {
                if (history.length <= 1) return;
                
                redoStack.push(history.pop());
                currentState = history[history.length - 1];
                ctx.putImageData(currentState, 0, 0);
            }
            
            // Redo last undone action
            function redo() {
                if (redoStack.length === 0) return;
                
                const state = redoStack.pop();
                history.push(state);
                currentState = state;
                ctx.putImageData(currentState, 0, 0);
            }
            
            // Load image to canvas
            function loadImage(file) {
                if (!file) return;
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Resize canvas to fit image proportionally
                        const maxWidth = 800;
                        const maxHeight = 600;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }
                        
                        if (height > maxHeight) {
                            width = (maxHeight / height) * width;
                            height = maxHeight;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Clear canvas and draw image
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Store original image for filters
                        originalImage = img;
                        hasImage = true;
                        
                        // Reset adjustments
                        brightnessSlider.value = 0;
                        contrastSlider.value = 0;
                        saturationSlider.value = 0;
                        brightnessValue.textContent = '0';
                        contrastValue.textContent = '0';
                        saturationValue.textContent = '0';
                        
                        // Save state
                        saveState();
                        
                        // Resize canvas display
                        resizeCanvas();
                    };
                    img.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            }
            
            // Apply filters to image
            function applyFilter(filterType) {
                if (!hasImage) return;
                
                showLoading();
                
                // Use setTimeout to allow the loading overlay to appear
                setTimeout(() => {
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    switch (filterType) {
                        case 'grayscale':
                            for (let i = 0; i < data.length; i += 4) {
                                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                                data[i] = avg;
                                data[i + 1] = avg;
                                data[i + 2] = avg;
                            }
                            break;
                        case 'sepia':
                            for (let i = 0; i < data.length; i += 4) {
                                const r = data[i];
                                const g = data[i + 1];
                                const b = data[i + 2];
                                
                                data[i] = Math.min(255, (r * 0.393) + (g * 0.769) + (b * 0.189));
                                data[i + 1] = Math.min(255, (r * 0.349) + (g * 0.686) + (b * 0.168));
                                data[i + 2] = Math.min(255, (r * 0.272) + (g * 0.534) + (b * 0.131));
                            }
                            break;
                        case 'invert':
                            for (let i = 0; i < data.length; i += 4) {
                                data[i] = 255 - data[i];
                                data[i + 1] = 255 - data[i + 1];
                                data[i + 2] = 255 - data[i + 2];
                            }
                            break;
                        case 'blur':
                            applyConvolution(data, [
                                1/9, 1/9, 1/9,
                                1/9, 1/9, 1/9,
                                1/9, 1/9, 1/9
                            ]);
                            break;
                        case 'sharpen':
                            applyConvolution(data, [
                                0, -1, 0,
                                -1, 5, -1,
                                0, -1, 0
                            ]);
                            break;
                        case 'edge-detect':
                            applyConvolution(data, [
                                -1, -1, -1,
                                -1, 8, -1,
                                -1, -1, -1
                            ]);
                            break;
                        case 'emboss':
                            applyConvolution(data, [
                                -2, -1, 0,
                                -1, 1, 1,
                                0, 1, 2
                            ]);
                            break;
                        case 'vintage':
                            for (let i = 0; i < data.length; i += 4) {
                                const r = data[i];
                                const g = data[i + 1];
                                const b = data[i + 2];
                                
                                data[i] = Math.min(255, (r * 0.9) + 20);
                                data[i + 1] = Math.min(255, (g * 0.7) + 20);
                                data[i + 2] = Math.min(255, (b * 0.5) + 20);
                            }
                            break;
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    saveState();
                    hideLoading();
                }, 50);
            }
            
            // Apply convolution filter (for blur, sharpen, etc.)
            function applyConvolution(data, weights) {
                const side = Math.round(Math.sqrt(weights.length));
                const halfSide = Math.floor(side/2);
                const width = canvas.width;
                const height = canvas.height;
                
                // Create a temporary copy of the image data
                const tempData = new Uint8ClampedArray(data.length);
                for (let i = 0; i < data.length; i++) {
                    tempData[i] = data[i];
                }
                
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const dstOff = (y * width + x) * 4;
                        let r = 0, g = 0, b = 0;
                        
                        for (let cy = 0; cy < side; cy++) {
                            for (let cx = 0; cx < side; cx++) {
                                const scy = y + cy - halfSide;
                                const scx = x + cx - halfSide;
                                
                                if (scy >= 0 && scy < height && scx >= 0 && scx < width) {
                                    const srcOff = (scy * width + scx) * 4;
                                    const wt = weights[cy * side + cx];
                                    r += tempData[srcOff] * wt;
                                    g += tempData[srcOff + 1] * wt;
                                    b += tempData[srcOff + 2] * wt;
                                }
                            }
                        }
                        
                        data[dstOff] = Math.min(255, Math.max(0, r));
                        data[dstOff + 1] = Math.min(255, Math.max(0, g));
                        data[dstOff + 2] = Math.min(255, Math.max(0, b));
                    }
                }
            }
            
            // Apply brightness, contrast, and saturation adjustments
            function applyAdjustments() {
                if (!hasImage || !originalImage) return;
                
                showLoading();
                
                setTimeout(() => {
                    // Reset canvas
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
                    
                    // Get image data
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Get adjustment values
                    const brightness = parseInt(brightnessSlider.value) / 100;
                    const contrast = parseInt(contrastSlider.value) / 100;
                    const saturation = parseInt(saturationSlider.value) / 100;
                    
                    // Apply adjustments
                    for (let i = 0; i < data.length; i += 4) {
                        // Brightness
                        if (brightness !== 0) {
                            data[i] = brightness > 0 ? 
                                data[i] * (1 + brightness) : 
                                data[i] + (255 * brightness);
                            data[i + 1] = brightness > 0 ? 
                                data[i + 1] * (1 + brightness) : 
                                data[i + 1] + (255 * brightness);
                            data[i + 2] = brightness > 0 ? 
                                data[i + 2] * (1 + brightness) : 
                                data[i + 2] + (255 * brightness);
                        }
                        
                        // Contrast
                        if (contrast !== 0) {
                            const factor = (259 * (contrast + 1)) / (255 * (1 - contrast));
                            data[i] = factor * (data[i] - 128) + 128;
                            data[i + 1] = factor * (data[i + 1] - 128) + 128;
                            data[i + 2] = factor * (data[i + 2] - 128) + 128;
                        }
                        
                        // Saturation
                        if (saturation !== 0) {
                            const gray = 0.2989 * data[i] + 0.5870 * data[i + 1] + 0.1140 * data[i + 2];
                            data[i] = gray * (1 - saturation) + data[i] * saturation;
                            data[i + 1] = gray * (1 - saturation) + data[i + 1] * saturation;
                            data[i + 2] = gray * (1 - saturation) + data[i + 2] * saturation;
                        }
                        
                        // Ensure values are within range
                        data[i] = Math.min(255, Math.max(0, data[i]));
                        data[i + 1] = Math.min(255, Math.max(0, data[i + 1]));
                        data[i + 2] = Math.min(255, Math.max(0, data[i + 2]));
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    hideLoading();
                }, 50);
            }
            
            // Rotate image
            function rotateImage(direction) {
                if (!hasImage) return;
                
                showLoading();
                
                setTimeout(() => {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    // Swap width and height
                    tempCanvas.width = canvas.height;
                    tempCanvas.height = canvas.width;
                    
                    tempCtx.save();
                    
                    if (direction === 'left') {
                        tempCtx.translate(0, tempCanvas.width);
                        tempCtx.rotate(-Math.PI / 2);
                    } else {
                        tempCtx.translate(tempCanvas.height, 0);
                        tempCtx.rotate(Math.PI / 2);
                    }
                    
                    tempCtx.drawImage(canvas, 0, 0);
                    tempCtx.restore();
                    
                    // Update canvas dimensions
                    const oldWidth = canvas.width;
                    canvas.width = canvas.height;
                    canvas.height = oldWidth;
                    
                    // Draw rotated image back to main canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(tempCanvas, 0, 0);
                    
                    // Update original image
                    const img = new Image();
                    img.onload = function() {
                        originalImage = img;
                        saveState();
                        resizeCanvas();
                        hideLoading();
                    };
                    img.src = canvas.toDataURL();
                }, 50);
            }
            
            // Flip image
            function flipImage(direction) {
                if (!hasImage) return;
                
                showLoading();
                
                setTimeout(() => {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    
                    tempCtx.save();
                    
                    if (direction === 'horizontal') {
                        tempCtx.translate(tempCanvas.width, 0);
                        tempCtx.scale(-1, 1);
                    } else {
                        tempCtx.translate(0, tempCanvas.height);
                        tempCtx.scale(1, -1);
                    }
                    
                    tempCtx.drawImage(canvas, 0, 0);
                    tempCtx.restore();
                    
                    // Draw flipped image back to main canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(tempCanvas, 0, 0);
                    
                    // Update original image
                    const img = new Image();
                    img.onload = function() {
                        originalImage = img;
                        saveState();
                        hideLoading();
                    };
                    img.src = canvas.toDataURL();
                }, 50);
            }
            
            // Start crop
            function startCrop() {
                isCropping = true;
                canvas.style.cursor = 'crosshair';
                cropControls.style.display = 'flex';
            }
            
            // Apply crop
            function applyCrop() {
                if (!isCropping) return;
                
                showLoading();
                
                setTimeout(() => {
                    // Ensure crop coordinates are valid
                    const x = Math.min(cropStartX, cropEndX);
                    const y = Math.min(cropStartY, cropEndY);
                    const width = Math.abs(cropEndX - cropStartX);
                    const height = Math.abs(cropEndY - cropStartY);
                    
                    if (width > 10 && height > 10) {
                        const tempCanvas = document.createElement('canvas');
                        const tempCtx = tempCanvas.getContext('2d');
                        
                        tempCanvas.width = width;
                        tempCanvas.height = height;
                        
                        // Copy the selected portion to the temp canvas
                        tempCtx.drawImage(canvas, x, y, width, height, 0, 0, width, height);
                        
                        // Resize main canvas
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Draw cropped image back to main canvas
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(tempCanvas, 0, 0);
                        
                        // Update original image
                        const img = new Image();
                        img.onload = function() {
                            originalImage = img;
                            saveState();
                            resizeCanvas();
                        };
                        img.src = canvas.toDataURL();
                    }
                    
                    // Reset crop state
                    cancelCrop();
                    hideLoading();
                }, 50);
            }
            
            // Cancel crop
            function cancelCrop() {
                isCropping = false;
                canvas.style.cursor = 'crosshair';
                cropControls.style.display = 'none';
                
                // Redraw canvas to remove crop overlay
                ctx.putImageData(currentState, 0, 0);
            }
            
            // Draw crop overlay
            function drawCropOverlay() {
                // Restore original image
                ctx.putImageData(currentState, 0, 0);
                
                // Calculate crop dimensions
                const x = Math.min(cropStartX, cropEndX);
                const y = Math.min(cropStartY, cropEndY);
                const width = Math.abs(cropEndX - cropStartX);
                const height = Math.abs(cropEndY - cropStartY);
                
                // Draw semi-transparent overlay
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Clear the crop area
                ctx.clearRect(x, y, width, height);
                
                // Draw border around crop area
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, width, height);
            }
            
            // Add text to canvas
            function startAddText() {
                if (textInput.value.trim() === '') {
                    alert('Please enter some text');
                    return;
                }
                
                isAddingText = true;
                canvas.style.cursor = 'text';
                addTextBtn.style.display = 'none';
                cancelTextBtn.style.display = 'block';
            }
            
            // Cancel text addition
            function cancelAddText() {
                isAddingText = false;
                canvas.style.cursor = 'crosshair';
                addTextBtn.style.display = 'block';
                cancelTextBtn.style.display = 'none';
            }
            
            // Place text on canvas
            function placeText(x, y) {
                const text = textInput.value;
                const color = textColor.value;
                const font = fontFamily.value;
                
                ctx.font = `${fontSize}px ${font}`;
                ctx.fillStyle = color;
                ctx.fillText(text, x, y);
                
                saveState();
                cancelAddText();
            }
            
            // Show loading overlay
            function showLoading() {
                loadingOverlay.style.display = 'flex';
            }
            
            // Hide loading overlay
            function hideLoading() {
                loadingOverlay.style.display = 'none';
            }
            
            // Event listeners for mouse
            canvas.addEventListener('mousedown', function(e) {
                if (isCropping) {
                    const coords = getCanvasCoordinates(e);
                    cropStartX = coords.x;
                    cropStartY = coords.y;
                    cropEndX = coords.x;
                    cropEndY = coords.y;
                } else if (isAddingText) {
                    const coords = getCanvasCoordinates(e);
                    placeText(coords.x, coords.y);
                } else {
                    startDrawing(e);
                }
            });
            
            canvas.addEventListener('mousemove', function(e) {
                if (isCropping && e.buttons === 1) {
                    const coords = getCanvasCoordinates(e);
                    cropEndX = coords.x;
                    cropEndY = coords.y;
                    drawCropOverlay();
                } else {
                    draw(e);
                }
            });
            
            canvas.addEventListener('mouseup', function() {
                if (isCropping) {
                    drawCropOverlay();
                } else {
                    stopDrawing();
                }
            });
            
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Event listeners for touch
            canvas.addEventListener('touchstart', function(e) {
                if (isAddingText) {
                    const coords = getCanvasCoordinates(e);
                    placeText(coords.x, coords.y);
                } else {
                    startDrawing(e);
                }
            });
            
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
            
            // Color selection
            colorOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    // Update current color
                    currentColor = this.dataset.color;
                    colorPicker.value = currentColor;
                    isEraser = false;
                    drawBtn.classList.add('active');
                    eraserBtn.classList.remove('active');
                });
            });
            
            // Custom color picker
            colorPicker.addEventListener('input', function() {
                currentColor = this.value;
                // Remove selected class from all options
                colorOptions.forEach(opt => opt.classList.remove('selected'));
                isEraser = false;
                drawBtn.classList.add('active');
                eraserBtn.classList.remove('active');
            });
            
            // Brush size slider
            brushSizeSlider.addEventListener('input', function() {
                brushSize = this.value;
                updateSizeValue();
            });
            
            // Font size slider
            fontSizeSlider.addEventListener('input', function() {
                fontSize = this.value;
                updateFontSizeValue();
            });
            
            // Draw button
            drawBtn.addEventListener('click', function() {
                isEraser = false;
                this.classList.add('active');
                eraserBtn.classList.remove('active');
            });
            
            // Eraser button
            eraserBtn.addEventListener('click', function() {
                isEraser = true;
                this.classList.add('active');
                drawBtn.classList.remove('active');
            });
            
            // Clear canvas button
            clearBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to clear the canvas?')) {
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    hasImage = false;
                    originalImage = null;
                    saveState();
                }
            });
            
            // Save drawing button
            saveBtn.addEventListener('click', function() {
                const link = document.createElement('a');
                link.download = 'image-editor-result.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
            
            // Image upload
            imageUpload.addEventListener('change', function() {
                loadImage(this.files[0]);
            });
            
            // Adjustment sliders
            brightnessSlider.addEventListener('input', function() {
                brightnessValue.textContent = this.value;
            });
            
            contrastSlider.addEventListener('input', function() {
                contrastValue.textContent = this.value;
            });
            
            saturationSlider.addEventListener('input', function() {
                saturationValue.textContent = this.value;
            });
            
            brightnessSlider.addEventListener('change', applyAdjustments);
            contrastSlider.addEventListener('change', applyAdjustments);
            saturationSlider.addEventListener('change', applyAdjustments);
            
            // Transform buttons
            rotateLeftBtn.addEventListener('click', function() {
                rotateImage('left');
            });
            
            rotateRightBtn.addEventListener('click', function() {
                rotateImage('right');
            });
            
            flipHBtn.addEventListener('click', function() {
                flipImage('horizontal');
            });
            
            flipVBtn.addEventListener('click', function() {
                flipImage('vertical');
            });
            
            // Crop buttons
            cropBtn.addEventListener('click', startCrop);
            applyCropBtn.addEventListener('click', applyCrop);
            cancelCropBtn.addEventListener('click', cancelCrop);
            
            // Filter buttons
            grayscaleBtn.addEventListener('click', function() {
                applyFilter('grayscale');
            });
            
            sepiaBtn.addEventListener('click', function() {
                applyFilter('sepia');
            });
            
            invertBtn.addEventListener('click', function() {
                applyFilter('invert');
            });
            
            blurBtn.addEventListener('click', function() {
                applyFilter('blur');
            });
            
            sharpenBtn.addEventListener('click', function() {
                applyFilter('sharpen');
            });
            
            edgeDetectBtn.addEventListener('click', function() {
                applyFilter('edge-detect');
            });
            
            embossBtn.addEventListener('click', function() {
                applyFilter('emboss');
            });
            
            vintageBtn.addEventListener('click', function() {
                applyFilter('vintage');
            });
            
            resetFiltersBtn.addEventListener('click', function() {
                if (!hasImage || !originalImage) return;
                
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
                saveState();
            });
            
            // Text buttons
            addTextBtn.addEventListener('click', startAddText);
            cancelTextBtn.addEventListener('click', cancelAddText);
            
            // History buttons
            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);
            
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    this.classList.add('active');
                    document.getElementById(`${this.dataset.tab}-tab`).classList.add('active');
                });
            });
            
            // File upload button
            document.querySelector('.file-upload-btn').addEventListener('click', function() {
                imageUpload.click();
            });
            
            // Initialize size value display
            updateSizeValue();
            updateFontSizeValue();
        });
    </script>
</body>
</html>